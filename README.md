# Hot-Path Detection over Citi-Bike Streams (OpenCEP Extension)

This project extends [OpenCEP](https://github.com/Cristiana-Cocheci/OpenCEP) with an optimized **Complex Event Processing (CEP)** pipeline for detecting **hot paths** (frequent trip sequences) in the 2019 Citi-Bike dataset.

The system is designed for **low latency**, **high throughput**, and **scalability** under realistic hardware constraints.

---
This project:

- Detects **popular bike paths** ending at specific stations.
- Processes **1,000,000+ events** from Citi-Bike logs.
- Balances **recall vs. latency** using:
  - Parallel event processing.
  - State-aware **load shedding**.
  - Fixed-size partial match buffers.

---

## Key Features

- **OpenCEP-based architecture**
  - Reuses pattern construction, state management, and evaluation trees.
  - Adds custom modules for data ingestion, metrics, and shedding.

- **DataFrame-based input**
  - Loads CSV trips via `pandas` once.
  - Streams preprocessed events directly to the CEP engine.

- **Pattern & evaluation tree**
  - Uses `SEQ` + `Kleene Closure` + primitive events to model hot paths.
  - Enforces time-window and station constraints in the tree nodes.

- **Parallelization by bike ID**
  - Shards events by `bike_id % num_threads`.
  - Each shard has its own evaluation tree and state.
  - Results merged into a single output stream.

- **State-aware load shedding**
  - Triggers when:
    - 95th percentile latency over last 1000 events exceeds a threshold.
    - Partial match buffer size exceeds a fixed limit (e.g. 30).
  - Uses **‚Äúoldest‚Äù** strategy (drop earliest partial matches).
  - Controls memory and latency at the cost of a small recall drop.

- **Metrics**
  - 95th percentile latency.
  - Throughput (events/s).
  - CPU utilization.

---

## üìä Performance (Best Configuration)

On ~1M Citi-Bike events:

- **Runtime:** ~30 minutes
- **95th percentile latency:** ~60 ms
- **Throughput:** ~500 events/s
- **Recall:** ~0.55 (vs. theoretical upper bound ~0.7)
- **CPU utilization:** ~92‚Äì94%
- **Memory:** bounded via fixed-size partial match buffers

Hardware used in testing:

- Intel i5-10300H (8 cores, 16 GB RAM)
- Apple M3 Pro (12 cores, 18 GB RAM)

---

## Evaluation

To evaluate correctness and recall:

- A synthetic dataset was generated by:
  - Inserting a new ‚Äútarget station‚Äù.
  - Planting synthetic hot paths of length 2‚Äì5 events.
- Only paths within a 31-minute window are theoretically detectable:
  - 4,400 generated paths/subpaths ‚Üí 3,155 detectable ‚Üí max recall ‚âà 0.7.
- Engine achieves **recall ‚âà 0.55** with **no false positives**  
  (full paths and valid subpaths both counted as correct detections).

---

## Running the project

1. Clone the extended OpenCEP repo:

   ```bash
   git clone https://github.com/Cristiana-Cocheci/OpenCEP.git
   cd OpenCEP

2. Run the notebook example/final_testing.ipynb

